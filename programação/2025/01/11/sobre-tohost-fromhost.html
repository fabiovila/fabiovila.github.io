<!DOCTYPE html>
<html lang="pt-BR">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Primary Meta Tags -->
    <title>Sobre tohost e fromhost - RISCV</title>
    <meta name="title" content="Sobre tohost e fromhost - RISCV" />
    <meta name="description" content="" />
    

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="/programa%C3%A7%C3%A3o/2025/01/11/sobre-tohost-fromhost.html" />
    <meta property="og:title" content="Sobre tohost e fromhost - RISCV" />
    <meta property="og:description" content="Algumas informações coletadas sobre tohost e fromhost no simulador de RISCV Spike"  />
    <meta property="og:image" content="/assets/imgs/terminal-linux.jpg" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="/programa%C3%A7%C3%A3o/2025/01/11/sobre-tohost-fromhost.html" />
    <meta property="twitter:title" content="Sobre tohost e fromhost - RISCV"  />
    <meta property="twitter:description" content="Algumas informações coletadas sobre tohost e fromhost no simulador de RISCV Spike" />
    <meta property="twitter:image" content="/assets/imgs/terminal-linux.jpg"/>

    <!-- Meta Tags Generated with https://metatags.io -->
    <link rel="preload"  href='/assets/css/style.css' as="style" type="text/css">
    <link rel="stylesheet"  href='/assets/css/style.css'>
    <link rel="stylesheet"  href='/assets/css/github.css'>
    <script rel="preload" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/js/all.min.js" integrity="sha512-6sSYJqDreZRZGkJ3b+YfdhB3MzmuP9R7X1QZ6g5aIXhRvR1Y/N/P47jmnkENm7YL3oqsmI6AK+V6AD99uWDnIw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var $ = function(id){return document.getElementById(id)};
        MathJax = {
          jax: ["input/TeX","output/HTML-CSS"],
          chtml: { displayAlign: 'left'      },
          tex: {
            inlineMath: [['$', '$']],
            displayMath:[['$$', '$$'], ['\\[', '\\]']]
          }
          };
    </script>
        <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>      
        <script>hljs.highlightAll();</script>
         <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-PY9DT1RWSW"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-PY9DT1RWSW');
        </script>
</head>

    <body>
    <nav class="navbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item"  href="/">
          <h1 class="has-text-weight-bold is-capitalized" >Fabio Vila</h1>
        </a>
        <span class="navbar-burger" data-target="navbarMenuHeroA">
          <span></span>
          <span></span>
          <span></span>
        </span>
      </div>
      <div id="navbarMenuHeroA" class="navbar-menu">
        <div class="navbar-end">
          <a href="/" class="navbar-item">
            Home
          </a>
          <a href="https://vilaboard.com" class="navbar-item">
            Vilaboard
          </a>
        </div>
      </div>
    </div>
  </nav>


<section class="section ">
<div class="columns is-centered">
<div class="column is-9 ">
<div class="content is-fluid">

  <header class="mb-5">
    <h1 class="title is-warning">Sobre tohost e fromhost - RISCV</h1>
    <h4 class="is-size-1-tablet has-text-weight-light is-family-sans-serif"></h4>
    
    <h4 class="is-size-5-tablet has-text-weight-light is-family-sans-serif">Algumas informações coletadas sobre tohost e fromhost no simulador de RISCV Spike</h4>
    
    <hr class="m-1"/>
    <small class="is-size-6-tablet has-text-weight-light pl-2 has-text-dark-grey" ><span class="icon "><i class="fa fa-user "></i></span>
      
      Fabio
         
    <span class="icon"><i class="fa fa-calendar"></i></span>  
     11 Jan 2025
     <span class="icon"><i class="fa fa-bars"></i></span>
    programação
    <span class="icon"><i class="fa fa-tag"></i></span>  
    riscv
    </small>
    <hr class="mt-1 mb-5"/>
    
    <div class="h-400">
        
        <img class="image" style="width:100%" src="/assets/imgs/terminal-linux.jpg"/>
        
    </div>
    


  </header>

  <article class="mt-5">
    <h3 id="resumo-e-explicação-da-funcionalidade-de-tohost-e-fromhost-no-spike-e-em-ambientes-risc-v">Resumo e Explicação da Funcionalidade de <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code> no Spike e em Ambientes RISC-V</h3>

<p>A comunicação entre o simulador Spike e o programa em execução é realizada por meio de dois registradores especiais: <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code>. Esses registradores não fazem parte de um padrão oficial do RISC-V, mas são uma convenção adotada pela equipe da UC Berkeley para permitir a interação entre o host (sistema que executa o simulador) e o target (código RISC-V em execução no simulador).</p>

<h4 id="definição-e-função">Definição e Função</h4>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">tohost</code></strong>: Este registrador é utilizado para enviar comandos e dados do target para o host. A escrita de valores específicos em <code class="language-plaintext highlighter-rouge">tohost</code> pode disparar a realização de uma chamada de sistema (syscall) ou a terminação do programa em execução.</p>

    <ul>
      <li>Se o bit menos significativo (LSB) for 0, os bits superiores representam um ponteiro para uma estrutura que descreve a chamada de sistema.</li>
      <li>Se o LSB for 1, os bits superiores contêm o código de saída do programa, onde o valor 0 indica sucesso e qualquer outro valor indica falha.</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">fromhost</code></strong>: Este registrador é usado pelo host para enviar respostas ou comandos ao target. O target deve verificar periodicamente o valor de <code class="language-plaintext highlighter-rouge">fromhost</code> para identificar novos comandos recebidos.</p>
  </li>
</ol>

<h4 id="definição-de-tohost-e-fromhost">Definição de <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code></h4>

<p>Para se comunicar com o simulador uma região da memória precisa ter o simbolo associado a estas duas localidades. Há duas formas de se fazer isso. A primeira é através do linker script:</p>

<pre><code class="language-linker">OUTPUT_ARCH("riscv")

ENTRY(_start)
EXTERN(_vectors)
SECTIONS
{

    . = 0x80000000;

    .tohost : ALIGN(0x1000)
    {
        *(.tohost)
    }

    .fromhost : ALIGN(0x1000)
    {
        *(.fromhost)
    }

    .text : ALIGN(0x1000)  {DEFINIÇÕES DA SEÇÃO .text}
}
</code></pre>
<p>E no código em C associamos uma variável a essas seções:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tohost</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">".tohost"</span><span class="p">)));</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fromhost</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">".fromhost"</span><span class="p">)));</span>
</code></pre></div></div>
<p>Então basta escrever/ler nessas variáveis que o simulador estará monitorando.</p>

<p>A segunda forma é através de código em assembly:</p>

<pre><code class="language-assembly">.section .text

.globl exit
# Função void exit(long) RV64
.globl exit
exit:
        slli a0, a0, 1
        ori a0, a0, 1
        la t0, tohost
        sd a0, 0(t0)
        1: j 1b

.globl putchar
putchar:
        li  t1, 0x0101000000000000
        or  a0, t1, a0
        la  t0, tohost
        sd  a0, 0(t0) # Cuidado não é sb!! sb grava bytes.
        ret

.section .tohost, "aw", @progbits
.align 6
.globl tohost
tohost: .dword 0

.align 6
.globl fromhost
fromhost: .dword 0
</code></pre>
<p>Onde se ve as definições de <code class="language-plaintext highlighter-rouge">fromhost</code> e <code class="language-plaintext highlighter-rouge">tohost</code>bem como um exemplo de aplicação definindo a função <code class="language-plaintext highlighter-rouge">void exit(long)</code> e <code class="language-plaintext highlighter-rouge">void putchar(int)</code>.</p>

<h4 id="exemplo-de-uso">Exemplo de Uso</h4>

<p>Suponha que temos um programa bare-metal que precisa realizar uma chamada de sistema para imprimir um caractere no console. O processo seria semelhante ao seguinte:</p>

<ol>
  <li>O programa escreve um valor especial em <code class="language-plaintext highlighter-rouge">tohost</code>, indicando que deseja realizar uma operação de saída de caractere.</li>
  <li>O Spike detecta a escrita em <code class="language-plaintext highlighter-rouge">tohost</code> e interpreta o comando.</li>
  <li>O Spike executa a ação correspondente (por exemplo, imprime o caractere no console).</li>
  <li>Se necessário, o Spike pode responder ao programa por meio de <code class="language-plaintext highlighter-rouge">fromhost</code>.</li>
</ol>

<h4 id="estrutura-do-registro-tohost">Estrutura do Registro <code class="language-plaintext highlighter-rouge">tohost</code></h4>

<ul>
  <li><strong>Bits 63:56</strong>: Indicam o dispositivo. Existem dois dispositivos principais:
    <ul>
      <li>Dispositivo 0: Usado para chamadas de sistema (syscalls).</li>
      <li>Dispositivo 1: Dispositivo de caractere bloqueante (para leitura/escrita de caracteres).</li>
    </ul>
  </li>
  <li><strong>Bits 55:48</strong>: Indicam o comando:
    <ul>
      <li>Comando 0: Leitura de caractere (somente dispositivo 1).</li>
      <li>Comando 1: Escrita de caractere (somente dispositivo 1).</li>
    </ul>
  </li>
  <li><strong>Bits 47:0</strong>: Contêm o payload, que pode ser um ponteiro para uma estrutura de chamada de sistema ou um caractere a ser escrito.</li>
</ul>

<h4 id="considerações-para-rv32">Considerações para RV32</h4>

<p>Embora <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code> tenham um formato de 64 bits, em sistemas RV32 esses registradores são acessados como duas palavras de 32 bits. Isso pode causar problemas de concorrência ao escrever valores de 64 bits em sistemas RV32, pois a escrita ocorre em duas etapas. No entanto, devido ao fato de o Spike processar blocos de instruções (geralmente em lotes de 5000), esse problema raramente se manifesta.</p>

<h4 id="exemplo-de-implementação-no-freertos">Exemplo de Implementação no FreeRTOS</h4>

<p>Em uma demonstração do FreeRTOS executando no Spike, <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code> são utilizados para permitir que o sistema operacional emule chamadas de sistema Unix-like, possibilitando a saída de informações para o console e a interação com o host.</p>

<h4 id="limitações-e-alternativas">Limitações e Alternativas</h4>

<p>Embora <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code> sejam mecanismos útis, eles apresentam algumas limitações:</p>
<ul>
  <li>A falta de suporte completo para dispositivos em RV32.</li>
  <li>O uso de “magic numbers” (valores mágicos) que não são bem documentados.</li>
</ul>

<p>Como alternativa, recomenda-se o uso de chamadas de sistema por proxy (proxy syscalls), que oferecem uma interface mais padronizada e flexível para a comunicação entre o target e o host.</p>

<h4 id="conclusão">Conclusão</h4>

<p>A funcionalidade de <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code> é essencial para a execução e interação de programas bare-metal e sistemas operacionais no simulador Spike. Embora seja um mecanismo eficiente, a falta de documentação adequada torna seu uso complexo para novos desenvolvedores. Alternativas como proxy syscalls podem ser mais apropriadas em aplicações modernas.</p>

<h3 id="referências">Referências</h3>
<ul>
  <li>Código-fonte do Spike e exemplos de uso de <code class="language-plaintext highlighter-rouge">tohost</code> e <code class="language-plaintext highlighter-rouge">fromhost</code>.</li>
  <li>Documentação do OpenSBI e do FreeRTOS para RISC-V.</li>
  <li>Discussões em repositórios de projetos relacionados ao ecossistema RISC-V.</li>
</ul>


  </article>

</div>
</div>
</div>
</section>

<section class="section">
  <hr/>
  <nav class="level is-mobile">

    <div class="level-item">      
      
      
      <div>
        <p class="heading"><strong>Veja Também:</strong></p>
        <a href="/educa%C3%A7%C3%A3o/2024/12/14/10-exerc%C3%ADcios-probabilidade-banca-quadrix.html"><small>10 Questões de probabilidade resolvidas da Banca Quadrix - Matemática</small></br></a>
        <a href="/eletr%C3%B4nica/2025/03/16/radio-conversao-direta-fm.html"><small>Receptor FM de conversão direta - RF</small></a>
      </div>
    </div>
  </nav>
</section>
<section class="section">
  <div id="disqus_thread"></div>
<script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://fabiovila-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>



<footer class="footer has-background-dark has-text-white">
  <div class="content has-text-centered">
    <p>
      <strong>Fabio Vila</strong> by <a href="https://fabiovila-github-io">Fabio Vila</a>.
      The source code is licensed
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

    </p>
  </div>
<nav class="level">
      <div class="level-item has-text-centered">
        <div>
          <span class="icon has-text-warning">
            <i class="fas fa-envelope fa-lg"></i>
          </span>
          <p>
            <strong class="has-text-light">Email:</strong><br>
            <a class="has-text-link-light" href="mailto:fkvila@outlook.com">fkvila@outlook.com</a>
          </p>
        </div>
      </div>
      <div class="level-item has-text-centered">
        <div>
          <span class="icon has-text-info">
            <i class="fab fa-telegram fa-lg"></i>
          </span>
          <p>
            <strong class="has-text-light">Telegram:</strong><br>
            <a class="has-text-link-light" href="https://t.me/viladx2">t.me/viladx2</a>
          </p>
        </div>
      </div>

    </nav>
</footer>
</body>
</html>
